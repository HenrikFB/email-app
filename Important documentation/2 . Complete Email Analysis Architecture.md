# ğŸ“Š Email Analysis System - Complete Architecture Guide

**Updated:** November 26, 2025  
**Covers:** Full pipeline + 4 content retrieval strategies + Architecture patterns

---

## ğŸ“– Table of Contents

1. [System Overview](#system-overview)
2. [Content Retrieval Strategies](#content-retrieval-strategies)
3. [Use Cases & Examples](#use-cases--examples)
4. [Architecture & Design Patterns](#architecture--design-patterns)
5. [Important Files](#important-files)
6. [Debugging & Monitoring](#debugging--monitoring)

---

## ğŸ”„ System Overview

Your email analysis system is a **generic, AI-powered pipeline** that analyzes emails and extracts structured data. It's designed with **low coupling** and **flexible configuration** to handle diverse email types without code changes.

### **Core Pipeline (7 Steps)**

```
ğŸ“§ Email Received
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 1: Fetch & Store Email                                        â”‚
â”‚ â€¢ Retrieve from Microsoft Graph                                    â”‚
â”‚ â€¢ Extract: subject, from, date, HTML body, plain text             â”‚
â”‚ â€¢ Store in: analyzed_emails table                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 1.5: HTML Structure Analysis                                 â”‚
â”‚ â€¢ Count potential sections (divs, tables, articles)               â”‚
â”‚ â€¢ Find button_text_pattern matches (e.g., "Se jobbet" = 28)       â”‚
â”‚ â€¢ Detect structure: tables â†’ list format, headings â†’ sections     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 2: Extract ALL Links                                         â”‚
â”‚ â€¢ Parse entire HTML (before truncation)                           â”‚
â”‚ â€¢ Identify buttons: button_text_pattern, CSS classes, roles       â”‚
â”‚ â€¢ Example: 235 links found (28 buttons, 207 regular)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 2.5: Email Intent Extraction (AI)                            â”‚
â”‚ â€¢ Input: plain text + match_criteria + user_intent                â”‚
â”‚ â€¢ Output: refined goal, key terms, expected content               â”‚
â”‚ â€¢ Example: "Java, .NET, node.js, React, Angular, RPA..."          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 2.8: Link Validation                                         â”‚
â”‚ â€¢ Filter: unsubscribe, login, social media, etc.                  â”‚
â”‚ â€¢ Preserve: button_text_pattern matches (priority)                â”‚
â”‚ â€¢ Use: link_selection_guidance for overrides                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 3: AI Link Prioritization                                    â”‚
â”‚ â€¢ Create priority list: ğŸ¯ buttons FIRST, then regular links     â”‚
â”‚ â€¢ AI evaluates: refined goal + key terms + link context          â”‚
â”‚ â€¢ Apply: max_links_to_scrape limit (default 10)                  â”‚
â”‚ â€¢ Example: Selected 18/235 links â†’ scraped top 15                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 4: Content Retrieval â­ STRATEGY PATTERN                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Factory selects strategy based on config:                    â”‚ â”‚
â”‚ â”‚ â€¢ scrape_only          â†’ FirecrawlRetriever                  â”‚ â”‚
â”‚ â”‚ â€¢ search_only          â†’ TavilyRetriever                     â”‚ â”‚
â”‚ â”‚ â€¢ scrape_and_search    â†’ HybridRetriever                     â”‚ â”‚
â”‚ â”‚ â€¢ intelligent_discovery â†’ IntelligentDiscoveryRetriever â­   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â€¢ All implement same ContentRetriever interface (low coupling!)   â”‚
â”‚ â€¢ Resolve: SafeLinks â†’ actual URLs, store original_urls mapping   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 4.5: RAG Context (Optional)                                  â”‚
â”‚ â€¢ Fetch from assigned knowledge bases                             â”‚
â”‚ â€¢ Provide domain-specific context to AI                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 5: Email Body Analysis (Full Context AI)                     â”‚
â”‚ â€¢ Input: email plain text + match_criteria + extraction_fields   â”‚
â”‚ â€¢ AI extracts: structured data from email itself                 â”‚
â”‚ â€¢ Chunking: ONLY if content > token limit (rare)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 6: Scraped Pages Analysis (Parallel Full Context AI)         â”‚
â”‚ â€¢ Analyze ALL pages in parallel (not sequential)                 â”‚
â”‚ â€¢ Each page: 1 AI call with full content                         â”‚
â”‚ â€¢ Extract: same fields, match against criteria                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 7: Aggregation & Storage                                     â”‚
â”‚ â€¢ Combine: email + all scraped pages (matched + rejected)        â”‚
â”‚ â€¢ Build: data_by_source for UI (source attribution)             â”‚
â”‚ â€¢ Calculate: overall confidence (weighted average)               â”‚
â”‚ â€¢ Store: analyzed_emails with all results                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
ğŸ“Š Results displayed in UI with matched/rejected sources
```

---

## ğŸ¯ Content Retrieval Strategies

**Key Architectural Principle:** All strategies implement the same `ContentRetriever` interface, enabling **strategy pattern** with **zero coupling** to the orchestrator.

### **Strategy 1: `scrape_only` - Direct Scraping** âœ…

**Best for:** Job boards, public pages, direct URLs that work

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  USE CASE: JobIndex Email (Your Original Example)              â”‚
â”‚                                                                 â”‚
â”‚  Email contains:                                                â”‚
â”‚  â€¢ 28 job listings                                              â”‚
â”‚  â€¢ Each with "Se jobbet" button                                â”‚
â”‚  â€¢ Links to: jobindex.dk/job/xyz                               â”‚
â”‚                                                                 â”‚
â”‚  Flow with scrape_only:                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚ 1. Extract 28 "Se jobbet" button links   â”‚                 â”‚
â”‚  â”‚ 2. AI prioritizes: top 15 most relevant  â”‚                 â”‚
â”‚  â”‚ 3. Firecrawl scrapes each URL directly   â”‚                 â”‚
â”‚  â”‚ 4. Returns: full job description HTML     â”‚                 â”‚
â”‚  â”‚ 5. AI analyzes: each job page             â”‚                 â”‚
â”‚  â”‚ 6. Result: 1-2 matched, 13-14 rejected   â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                                 â”‚
â”‚  âœ… Works perfectly when:                                       â”‚
â”‚  â€¢ URLs are publicly accessible                                â”‚
â”‚  â€¢ No authentication required                                  â”‚
â”‚  â€¢ Direct links to content pages                               â”‚
â”‚                                                                 â”‚
â”‚  âŒ Fails when:                                                 â”‚
â”‚  â€¢ Login redirects (LinkedIn, gated content)                   â”‚
â”‚  â€¢ Expired tokens (SafeLinks with otpToken)                    â”‚
â”‚  â€¢ Paywalls or authentication walls                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Agent Configuration:
{
  "content_retrieval_strategy": "scrape_only",
  "button_text_pattern": "Se jobbet",
  "max_links_to_scrape": 15
}

Implementation: FirecrawlRetriever
File: lib/content-retrieval/firecrawl-retriever.ts
```

---

### **Strategy 2: `search_only` - Web Search** ğŸ”

**Best for:** Broad research, when URLs are unavailable, sentiment analysis

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  USE CASE: Research Email (No Direct Links)                    â”‚
â”‚                                                                 â”‚
â”‚  Email contains:                                                â”‚
â”‚  â€¢ "Latest developments in AI safety"                           â”‚
â”‚  â€¢ No specific links                                            â”‚
â”‚  â€¢ Need to find relevant articles                              â”‚
â”‚                                                                 â”‚
â”‚  Flow with search_only:                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚ 1. Extract intent: "AI safety research"  â”‚                 â”‚
â”‚  â”‚ 2. Generate search query from criteria   â”‚                 â”‚
â”‚  â”‚ 3. Tavily searches web (advanced depth)  â”‚                 â”‚
â”‚  â”‚ 4. Returns: Top 5 result snippets         â”‚                 â”‚
â”‚  â”‚ 5. AI analyzes: search result content    â”‚                 â”‚
â”‚  â”‚ 6. No scraping - uses snippets only      â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                                 â”‚
â”‚  âœ… Good for:                                                   â”‚
â”‚  â€¢ Broad topic research                                        â”‚
â”‚  â€¢ Sentiment/trend analysis                                    â”‚
â”‚  â€¢ When exact URLs don't matter                                â”‚
â”‚  â€¢ Fast results (no scraping overhead)                         â”‚
â”‚                                                                 â”‚
â”‚  âŒ Not ideal for:                                              â”‚
â”‚  â€¢ Detailed content extraction                                 â”‚
â”‚  â€¢ Specific document analysis                                  â”‚
â”‚  â€¢ When full page content is needed                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Agent Configuration:
{
  "content_retrieval_strategy": "search_only",
  "match_criteria": "AI safety research and developments",
  "max_links_to_scrape": 5
}

Implementation: TavilyRetriever
File: lib/content-retrieval/tavily-retriever.ts
```

---

### **Strategy 3: `scrape_and_search` - Hybrid Approach** ğŸ”€

**Best for:** Maximum coverage, when scraping might fail

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  USE CASE: Mixed Content Email                                 â”‚
â”‚                                                                 â”‚
â”‚  Email contains:                                                â”‚
â”‚  â€¢ 10 links (some might be gated)                              â”‚
â”‚  â€¢ Mix of public and potentially blocked content               â”‚
â”‚  â€¢ Need backup if scraping fails                               â”‚
â”‚                                                                 â”‚
â”‚  Flow with scrape_and_search:                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚ 1. Try Firecrawl scraping (parallel)     â”‚                 â”‚
â”‚  â”‚ 2. Simultaneously: Tavily web search     â”‚                 â”‚
â”‚  â”‚ 3. Merge results:                         â”‚                 â”‚
â”‚  â”‚    â€¢ Scraped content (if successful)      â”‚                 â”‚
â”‚  â”‚    â€¢ + Search snippets (always)           â”‚                 â”‚
â”‚  â”‚ 4. AI analyzes: combined data             â”‚                 â”‚
â”‚  â”‚ 5. Best of both worlds                    â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                                 â”‚
â”‚  âœ… Best for:                                                   â”‚
â”‚  â€¢ Unknown reliability of links                                â”‚
â”‚  â€¢ Want maximum context                                        â”‚
â”‚  â€¢ Don't mind extra API costs                                  â”‚
â”‚                                                                 â”‚
â”‚  âŒ Drawbacks:                                                  â”‚
â”‚  â€¢ Higher cost (both services)                                 â”‚
â”‚  â€¢ Slower (2 API calls per URL)                                â”‚
â”‚  â€¢ Potential data duplication                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Agent Configuration:
{
  "content_retrieval_strategy": "scrape_and_search",
  "max_links_to_scrape": 10
}

Implementation: HybridRetriever
File: lib/content-retrieval/hybrid-retriever.ts
```

---

### **Strategy 4: `intelligent_discovery` - Smart Web Discovery** â­ NEW!

**Best for:** LinkedIn emails, expired tokens, authentication walls, finding alternative sources

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  USE CASE: LinkedIn Job Email (Your Current Problem!)          â”‚
â”‚                                                                 â”‚
â”‚  Email contains:                                                â”‚
â”‚  â€¢ Link: "Software Developer BD Energy Â· Aarhus"               â”‚
â”‚  â€¢ URL: linkedin.com/comm/jobs/view/4347314118?otpToken=...    â”‚
â”‚  â€¢ Problem: otpToken expired â†’ redirects to login              â”‚
â”‚                                                                 â”‚
â”‚  âŒ scrape_only fails:                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚ Firecrawl â†’ LinkedIn login page           â”‚                 â”‚
â”‚  â”‚ Result: "Sign in to continue" (useless)   â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                                 â”‚
â”‚  âœ… intelligent_discovery succeeds:                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ STEP 1: Extract context from link text           â”‚         â”‚
â”‚  â”‚   â€¢ Link text: "Software Developer BD Energy      â”‚         â”‚
â”‚  â”‚     Â· Aarhus"                                      â”‚         â”‚
â”‚  â”‚   â€¢ Clean up: Remove "Easy Apply", "tidlige       â”‚         â”‚
â”‚  â”‚     medarbejdere", etc.                            â”‚         â”‚
â”‚  â”‚   â€¢ Result: "Software Developer BD Energy Aarhus" â”‚         â”‚
â”‚  â”‚                                                    â”‚         â”‚
â”‚  â”‚ STEP 2: Exclude original domain                   â”‚         â”‚
â”‚  â”‚   â€¢ Original: linkedin.com (inaccessible)         â”‚         â”‚
â”‚  â”‚   â€¢ Exclude from search results                   â”‚         â”‚
â”‚  â”‚                                                    â”‚         â”‚
â”‚  â”‚ STEP 3: Tavily web search                         â”‚         â”‚
â”‚  â”‚   â€¢ Query: "Software Developer BD Energy Aarhus"  â”‚         â”‚
â”‚  â”‚   â€¢ Exclude: linkedin.com                         â”‚         â”‚
â”‚  â”‚   â€¢ Returns 5 alternatives:                       â”‚         â”‚
â”‚  â”‚     1. dk.linkedin.com/jobs/view/... (score: 2.3) â”‚         â”‚
â”‚  â”‚     2. bdenergy.dk/careers/... (score: 2.3) âœ…    â”‚         â”‚
â”‚  â”‚     3. linkedin.com/posts/... (score: 1.0)        â”‚         â”‚
â”‚  â”‚     4. jobindex.dk/... (score: -1.8)              â”‚         â”‚
â”‚  â”‚     5. glassdoor.com/... (score: -2.0)            â”‚         â”‚
â”‚  â”‚                                                    â”‚         â”‚
â”‚  â”‚ STEP 4: Rank results intelligently                â”‚         â”‚
â”‚  â”‚   â€¢ Score based on:                                â”‚         â”‚
â”‚  â”‚     - URL depth (deeper = specific page)          â”‚         â”‚
â”‚  â”‚     - Query string length (short = direct link)   â”‚         â”‚
â”‚  â”‚     - Word matching (link text in URL)            â”‚         â”‚
â”‚  â”‚   â€¢ Ranked:                                        â”‚         â”‚
â”‚  â”‚     1. bdenergy.dk/careers/... (3.9) âœ…          â”‚         â”‚
â”‚  â”‚     2. dk.linkedin.com/... (2.3) âŒ              â”‚         â”‚
â”‚  â”‚     3. jobindex.dk (0.2) âš ï¸                       â”‚         â”‚
â”‚  â”‚                                                    â”‚         â”‚
â”‚  â”‚ STEP 5: Scrape top 3 with Firecrawl               â”‚         â”‚
â”‚  â”‚   â€¢ bdenergy.dk â†’ âœ… Success! (6.4KB)            â”‚         â”‚
â”‚  â”‚   â€¢ dk.linkedin.com â†’ âŒ Not supported            â”‚         â”‚
â”‚  â”‚   â€¢ jobindex.dk â†’ âœ… Success but generic         â”‚         â”‚
â”‚  â”‚                                                    â”‚         â”‚
â”‚  â”‚ STEP 6: Filter by size                             â”‚         â”‚
â”‚  â”‚   â€¢ bdenergy.dk: 6.4KB âœ… Perfect!                â”‚         â”‚
â”‚  â”‚   â€¢ jobindex.dk: 797KB âŒ Too large (aggregator)  â”‚         â”‚
â”‚  â”‚                                                    â”‚         â”‚
â”‚  â”‚ STEP 7: Return best result                         â”‚         â”‚
â”‚  â”‚   â€¢ URL: bdenergy.dk/unsolicited-software-developerâ”‚         â”‚
â”‚  â”‚   â€¢ Content: Full job description                 â”‚         â”‚
â”‚  â”‚   â€¢ Source: intelligent_discovery                 â”‚         â”‚
â”‚  â”‚   â€¢ Metadata: original URL, search query          â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                 â”‚
â”‚  ğŸ¯ Result for 5 LinkedIn links:                                â”‚
â”‚  â€¢ 3/5 found alternative sources âœ…                             â”‚
â”‚  â€¢ 2/5 no alternatives exist (job only on LinkedIn) âš ï¸          â”‚
â”‚  â€¢ Success rate: 60% (as good as it gets!)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Agent Configuration:
{
  "content_retrieval_strategy": "intelligent_discovery",
  "match_criteria": "Software developer < 5 years, Java/.NET/Node.js...",
  "max_links_to_scrape": 6
}

Implementation: IntelligentDiscoveryRetriever
File: lib/content-retrieval/intelligent-discovery-retriever.ts

Key Features:
â€¢ âœ… NO hardcoded domain lists
â€¢ âœ… Uses link text + email context for search
â€¢ âœ… Smart URL ranking (not just Tavily score)
â€¢ âœ… Size filtering (1KB - 150KB) to avoid aggregators
â€¢ âœ… Fallback to search snippets if scraping fails
â€¢ âœ… Logs Tavily results to debug file (04.1-tavily-search-results.json)
```

---

## ğŸ—ï¸ Architecture & Design Patterns

Your system demonstrates **excellent software engineering principles**:

### **1. Strategy Pattern** (Content Retrieval)

```typescript
// Interface (contract for all strategies)
export interface ContentRetriever {
  retrieve(url: string, context?: RetrievalContext): Promise<ContentRetrievalResult>
}

// Concrete Strategies
class FirecrawlRetriever implements ContentRetriever { ... }
class TavilyRetriever implements ContentRetriever { ... }
class HybridRetriever implements ContentRetriever { ... }
class IntelligentDiscoveryRetriever implements ContentRetriever { ... }

// Orchestrator uses interface, not concrete classes
async function analyzeEmail(input: AnalysisInput) {
  const retriever: ContentRetriever = createContentRetriever(strategy)
  //                ^^^^^^^^^^^^^^^^ 
  // Orchestrator only knows about the interface!
  // This is LOW COUPLING - can add new strategies without changing orchestrator
  
  const result = await retriever.retrieve(url, context)
}
```

**Benefits:**
- âœ… **Low Coupling**: Orchestrator doesn't depend on specific retrievers
- âœ… **Open/Closed Principle**: Open for extension (add new strategies), closed for modification (orchestrator unchanged)
- âœ… **Easy Testing**: Mock `ContentRetriever` interface
- âœ… **Runtime Flexibility**: User selects strategy via config

---

### **2. Factory Pattern** (Retriever Creation)

```typescript
// Factory: Creates correct retriever based on strategy
export function createContentRetriever(
  strategy: ContentRetrievalStrategy = 'scrape_only'
): ContentRetriever {
  switch (strategy) {
    case 'scrape_only': return new FirecrawlRetriever()
    case 'search_only': return new TavilyRetriever()
    case 'scrape_and_search': return new HybridRetriever()
    case 'intelligent_discovery': return new IntelligentDiscoveryRetriever()
  }
}

// Usage in orchestrator
const retriever = createContentRetriever(input.agentConfig.content_retrieval_strategy)
//                ^^^^^^^^^^^^^^^^^^^^^^
// Orchestrator NEVER directly instantiates retrievers!
```

**Benefits:**
- âœ… **Single Responsibility**: Factory handles object creation
- âœ… **Centralized Logic**: Strategy selection in one place
- âœ… **Easy to Extend**: Add new strategy = one line in factory

---

### **3. Configuration-Driven Architecture**

```typescript
// All behavior controlled by database config
interface AgentConfiguration {
  match_criteria: string               // What to look for
  extraction_fields: string            // What to extract
  user_intent?: string                 // Why analyzing
  button_text_pattern?: string         // How to find buttons
  max_links_to_scrape: number          // Scraping limit
  content_retrieval_strategy: string   // Which strategy â­
  link_selection_guidance?: string     // AI guidance
  extraction_examples?: string         // Few-shot learning
  analysis_feedback?: string           // Continuous improvement
}

// NO CODE CHANGES NEEDED - users configure via UI!
```

**Benefits:**
- âœ… **Zero Downtime Changes**: Update config without deployment
- âœ… **Per-User Customization**: Different strategies per agent
- âœ… **A/B Testing**: Easy to compare strategies
- âœ… **Rapid Iteration**: Tweak prompts/limits without coding

---

### **4. Debug Logging System**

```typescript
// Comprehensive logging at each step
export interface AnalysisDebugData {
  runId: string                    // Unique run identifier
  emailIntent: { ... }             // What we're looking for
  aiSelectedLinks: string[]        // Which links AI chose
  scrapingAttempts: [ ... ]        // What we tried to scrape
  scrapedContent: [ ... ]          // What we got
  finalResult: { ... }             // Final analysis
  
  // NEW: Tavily search results per URL (intelligent_discovery only)
  // File: 04.1-tavily-search-results.json
}

// Each run creates debug folder: debug-analysis-runs/{runId}/
// Files: 00-metadata.json, 01-email-fetched.json, 02-links-extracted.json...
```

**Benefits:**
- âœ… **Full Transparency**: See exactly what happened
- âœ… **Easy Debugging**: Compare expected vs actual at each step
- âœ… **Performance Analysis**: Track API calls, timing, costs
- âœ… **Strategy Comparison**: Compare `scrape_only` vs `intelligent_discovery` results

---

## ğŸ“ Important Files

### **Core Pipeline**

| File | Purpose | Key Functions |
|------|---------|--------------|
| `lib/email-analysis/orchestrator.ts` | Main pipeline orchestrator | `analyzeEmail()` - coordinates all 7 steps |
| `lib/email-analysis/link-extractor.ts` | Extract links from HTML | `extractLinksFromHtml()` - parse HTML, identify buttons |
| `lib/email-analysis/link-prioritization.ts` | AI link prioritization | `prioritizeLinksWithAI()` - rank links by relevance |
| `lib/email-analysis/full-context-analyzer.ts` | AI content analysis | `analyzeFullContext()` - extract structured data |
| `lib/email-analysis/aggregator.ts` | Combine results | `aggregateResults()` - merge email + scraped pages |
| `lib/email-analysis/debug-logger.ts` | Debug logging | `logDebugStep()` - create debug files |

### **Content Retrieval (Strategy Pattern)**

| File | Strategy | Purpose |
|------|----------|---------|
| `lib/content-retrieval/types.ts` | Interface | `ContentRetriever` interface, `RetrievalContext` |
| `lib/content-retrieval/factory.ts` | Factory | `createContentRetriever()` - select strategy |
| `lib/content-retrieval/firecrawl-retriever.ts` | `scrape_only` | Direct scraping with Firecrawl |
| `lib/content-retrieval/tavily-retriever.ts` | `search_only` | Web search with Tavily |
| `lib/content-retrieval/hybrid-retriever.ts` | `scrape_and_search` | Both Firecrawl + Tavily |
| `lib/content-retrieval/intelligent-discovery-retriever.ts` â­ | `intelligent_discovery` | Search for alternatives, then scrape |

### **External Service Clients**

| File | Service | Purpose |
|------|---------|---------|
| `lib/firecrawl/client.ts` | Firecrawl | `scrapeUrl()` - scrape web pages to markdown |
| `lib/tavily/client.ts` | Tavily | `searchWithTavily()` - web search API |
| `lib/graph/client.ts` | Microsoft Graph | `getEmailById()` - fetch emails |
| `lib/openai/client.ts` | OpenAI | `chatCompletion()` - AI analysis |

### **Database & UI**

| File | Purpose |
|------|---------|
| `supabase/migrations/019_add_intelligent_discovery_strategy.sql` | Database schema for new strategy |
| `app/dashboard/components/config-form.tsx` | UI for agent configuration |
| `app/dashboard/results/components/result-card.tsx` | UI for displaying results |
| `app/dashboard/emails/actions.ts` | Server actions for email analysis |

---

## ğŸ” Debugging & Monitoring

### **Debug Folder Structure**

Each analysis creates a folder: `debug-analysis-runs/{runId}/`

```
debug-analysis-runs/
â””â”€â”€ 1764142315243-AQMkADAw/           # runId (timestamp-emailId)
    â”œâ”€â”€ 00-metadata.json               # Agent config, email metadata
    â”œâ”€â”€ 01-email-fetched.json          # Raw email data
    â”œâ”€â”€ 01-email-plain-text.txt        # Email body (text)
    â”œâ”€â”€ 01-email-html.html             # Email body (HTML)
    â”œâ”€â”€ 1.5-html-structure-analysis.json  # Structure analysis
    â”œâ”€â”€ 02-links-extracted.json        # All 235 links found
    â”œâ”€â”€ 2.5-intent-extraction.json     # AI-extracted intent
    â”œâ”€â”€ 2.8-link-validation.json       # Filtered links
    â”œâ”€â”€ 03-ai-link-prioritization.json # AI-selected links
    â”œâ”€â”€ 04-content-retrieval-complete.json  # Scraping results
    â”œâ”€â”€ 04.1-tavily-search-results.json â­ NEW! (intelligent_discovery only)
    â”‚   # Contains:
    â”‚   # - originalUrl (the LinkedIn URL that failed)
    â”‚   # - searchQuery (what we searched for)
    â”‚   # - tavilyResults (all 5 alternatives Tavily found)
    â”‚   # - Each result: title, url, score, snippet
    â”œâ”€â”€ 05-email-analysis-complete.json # Email body analysis
    â”œâ”€â”€ 06-scraped-pages-analysis-complete.json  # All pages analyzed
    â”œâ”€â”€ 07-aggregation-complete.json   # Final aggregated result
    â”œâ”€â”€ 99-complete-run-data.json      # Complete run summary
    â””â”€â”€ SUMMARY.md                     # Human-readable summary
```

### **New: Tavily Search Results File** â­

When using `intelligent_discovery` strategy, a new file is created for **each URL searched**:

**`04.1-tavily-search-results.json`**

```json
{
  "originalUrl": "https://emea01.safelinks.protection.outlook.com/?url=...",
  "searchQuery": "Software Developer BD Energy Aarhus",
  "excludeDomains": ["emea01.safelinks.protection.outlook.com"],
  "tavilyResults": [
    {
      "title": "Software Developer at BD Energy",
      "url": "https://dk.linkedin.com/jobs/view/software-developer-at-bd-energy-4347314118",
      "score": 2.3,
      "snippet": "We are looking for a talented software developer to join our team in Aarhus. You will work with .NET, React, and Azure..."
    },
    {
      "title": "Unsolicited Software Developer â€“ Fullstack | BD Energy",
      "url": "https://bdenergy.dk/unsolicited-software-developer-fullstack/",
      "score": 2.3,
      "snippet": "At BD Energy, we're always looking for talented developers. Our tech stack includes C#, TypeScript, React, Next.js..."
    }
  ],
  "totalResults": 5
}
```

**Use this file to:**
- âœ… See what alternatives Tavily found for each LinkedIn URL
- âœ… Understand why certain URLs were ranked higher (score)
- âœ… Check if better alternatives exist that weren't scraped (top 3 only)
- âœ… Debug why some jobs weren't found (no public alternative exists)

---

## ğŸ¯ Strategy Selection Guide

### **Decision Tree**

```
Do you know the URLs are publicly accessible?
â”‚
â”œâ”€ YES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                      â”œâ”€â†’ Use: scrape_only
â”‚  Are the URLs always reliable?      â”‚    (fastest, cheapest)
â”‚  â””â”€ YES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â”‚  â””â”€ NO (sometimes fail) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                     â”œâ”€â†’ Use: scrape_and_search
â”‚     Do you need backup sources?    â”‚    (more robust, higher cost)
â”‚     â””â”€ YES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â”œâ”€ NO (authentication/tokens) â”€â”€â”€â”€â”€â”€â”
â”‚                                    â”œâ”€â†’ Use: intelligent_discovery
â”‚  Are these LinkedIn/gated URLs?   â”‚    (finds public alternatives)
â”‚  â””â”€ YES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â””â”€ NO DIRECT LINKS (research) â”€â”€â”€â”€â”€â”
                                    â”œâ”€â†’ Use: search_only
   Need to search by topic?         â”‚    (web search, no scraping)
   â””â”€ YES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **Quick Reference**

| Scenario | Best Strategy | Why |
|----------|---------------|-----|
| **JobIndex emails** | `scrape_only` | Direct URLs, always work âœ… |
| **LinkedIn job emails** | `intelligent_discovery` | Expired tokens, need alternatives ğŸ” |
| **Mixed newsletters** | `scrape_and_search` | Some might fail, want backup ğŸ”€ |
| **Topic research** | `search_only` | No URLs, search by keywords ğŸ“š |
| **Critical content** | `scrape_and_search` | Can't afford to miss data ğŸ’ª |

---

## ğŸš€ Performance & Costs

### **Strategy Comparison**

| Strategy | API Calls/URL | Speed | Cost | Reliability |
|----------|---------------|-------|------|-------------|
| `scrape_only` | 1 (Firecrawl) | Fast | Low | Fails on auth |
| `search_only` | 1 (Tavily) | Fastest | Low | Snippets only |
| `scrape_and_search` | 2 (both) | Slow | High | Very reliable |
| `intelligent_discovery` | 1-4 (1 search + 0-3 scrapes) | Medium | Medium | Best for gated |

**Cost Analysis (per email with 5 links):**

```
scrape_only:          5 Firecrawl calls          = $0.25
search_only:          5 Tavily calls             = $0.05
scrape_and_search:    10 calls (5F + 5T)         = $0.30
intelligent_discovery: ~15 calls (5T + ~10F)     = $0.35
                      (searches 5, scrapes 3 per search avg)
```

**Recommendation:**
- Start with `scrape_only` for known-good URLs
- Use `intelligent_discovery` only for LinkedIn/gated content
- Monitor success rate per strategy via debug logs

---

## ğŸ’¡ Future Enhancements

### **Planned Improvements**

1. **Cache Tavily Search Results** (intelligent_discovery)
   - Problem: Same job might appear in multiple emails
   - Solution: Cache search results by (linkText + domain)
   - Benefit: Reduce Tavily API calls by ~60%

2. **Learn from Successful Discoveries**
   - Problem: Don't know which alternative sources work best
   - Solution: Track: LinkedIn URL X â†’ Alternative Y (success rate)
   - Benefit: Prioritize known-good alternatives

3. **Multi-Agent Deep Research** (see original doc)
   - For high-value use cases (job hunting, investments)
   - Research company reputation, salary benchmarks, etc.

4. **Custom Pipelines** (only if needed)
   - Monitor: Which email types have low accuracy?
   - If pattern emerges: Create specialized pipeline
   - Else: Keep refining single pipeline

---

## ğŸ“Š Summary

Your email analysis system is **architecturally sound** with:

âœ… **Strategy Pattern** - Easy to add new retrieval strategies  
âœ… **Factory Pattern** - Centralized strategy selection  
âœ… **Configuration-Driven** - No code changes for behavior changes  
âœ… **Low Coupling** - Orchestrator independent of specific retrievers  
âœ… **Comprehensive Debugging** - Full visibility into each step  
âœ… **Intelligent Discovery** - Solves authentication/gated content problem  

**Key Achievement:** You can now handle **LinkedIn job emails** that previously failed with `scrape_only` by using `intelligent_discovery` to find alternative public sources. This is done **without hardcoding** - the system intelligently reasons about link context and discovers alternatives via web search.

**Next Steps:**
1. Test `intelligent_discovery` with more LinkedIn emails
2. Analyze `04.1-tavily-search-results.json` files to understand discovery quality
3. Compare success rates: `scrape_only` vs `intelligent_discovery`
4. Iterate on search query generation if needed

---

**Last Updated:** November 26, 2025  
**Version:** 2.0 (Added intelligent_discovery strategy)

