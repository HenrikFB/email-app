# ğŸ” Hybrid Search & AI Chat System

**Updated:** November 28, 2025  
**Covers:** True Hybrid Search (RRF) + Global Chat Widget + Automated KB Search + Multi-Intent Queries

---

## ğŸ“– Table of Contents

1. [System Overview](#system-overview)
2. [Hybrid Search Architecture](#hybrid-search-architecture)
3. [Global Chat Widget](#global-chat-widget)
4. [Automated KB Search](#automated-kb-search)
5. [Multi-Intent Query Strategies](#multi-intent-query-strategies)
6. [Database Schema](#database-schema)
7. [Architecture Patterns](#architecture-patterns)
8. [Important Files](#important-files)

---

## ğŸ¯ System Overview

The search system provides two main workflows:

### **1. Interactive Chat Search (Global Widget)**
```
User types query â†’ AI generates parallel searches â†’ Results displayed â†’ User clicks for details
```
- Available on every page via floating widget
- Searches both Knowledge Bases AND Analyzed Emails
- Optional page context awareness
- Conversation history (memory)

### **2. Automated KB Search (Analysis Pipeline)**
```
Email matches â†’ Extract data â†’ AI generates queries â†’ Search KBs â†’ Store results
```
- Runs automatically during email analysis (Step 8)
- Configurable per agent (single, multi_intent, ai_powered)
- Parallel query execution
- Auto-save to specified KB

---

## ğŸ”¬ Hybrid Search Architecture

### **What is Hybrid Search?**

Combines **semantic search** (vector similarity) with **full-text search** (keyword matching) using **Reciprocal Rank Fusion (RRF)**.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User Query: ".NET developer Aarhus"                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â†“                                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SEMANTIC SEARCH     â”‚                 â”‚ FULL-TEXT SEARCH    â”‚
â”‚ (Vector Similarity) â”‚                 â”‚ (Keyword Match)     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ OpenAI embeddings â”‚                 â”‚ â€¢ PostgreSQL FTS    â”‚
â”‚ â€¢ text-embedding-   â”‚                 â”‚ â€¢ websearch_to_     â”‚
â”‚   3-small (1536d)   â”‚                 â”‚   tsquery()         â”‚
â”‚ â€¢ Cosine similarity â”‚                 â”‚ â€¢ GIN index on fts  â”‚
â”‚ â€¢ Concept matching  â”‚                 â”‚ â€¢ Exact keywords    â”‚
â”‚ â€¢ Handles synonyms  â”‚                 â”‚ â€¢ Handles typos     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“                                         â†“
         â”‚    Results with rank positions          â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RECIPROCAL RANK FUSION (RRF)                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ RRF Score = Î£ (1 / (k + rank_i)) Ã— weight_i                        â”‚
â”‚                                                                     â”‚
â”‚ Where:                                                              â”‚
â”‚   k = 50 (smoothing constant)                                       â”‚
â”‚   rank_i = position in semantic/fulltext results                    â”‚
â”‚   weight_i = 1.0 for both (configurable)                           â”‚
â”‚                                                                     â”‚
â”‚ Example: Doc appears rank 1 in semantic, rank 3 in fulltext         â”‚
â”‚   RRF = (1/51) + (1/53) = 0.0196 + 0.0189 = 0.0385                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FINAL OUTPUT                                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ Combined ranked results                                           â”‚
â”‚ â€¢ match_type: 'hybrid' | 'fulltext' | 'semantic'                   â”‚
â”‚ â€¢ snippet: Highlighted excerpt with <mark>keywords</mark>           â”‚
â”‚ â€¢ similarity: Normalized score (0-1)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **Why Hybrid Search?**

| Search Type | Pros | Cons | Best For |
|-------------|------|------|----------|
| **Semantic Only** | Concept matching, synonyms | Misses exact terms like ".NET" | Natural language queries |
| **Full-text Only** | Exact matches, fast | No concept understanding | Keyword searches |
| **Hybrid (RRF)** | Best of both worlds | Slightly more compute | Production use |

### **Match Type Indicators**

```typescript
'hybrid'   // Found by BOTH semantic AND fulltext (highest confidence)
'fulltext' // Found by keyword match only
'semantic' // Found by vector similarity only
```

### **PostgreSQL Implementation**

```sql
-- Full-text search column (auto-generated)
ALTER TABLE kb_chunks ADD COLUMN fts tsvector
  GENERATED ALWAYS AS (to_tsvector('simple', content)) STORED;

-- GIN index for fast searches
CREATE INDEX idx_kb_chunks_fts ON kb_chunks USING gin(fts);

-- RRF function combines results
CREATE OR REPLACE FUNCTION hybrid_search_knowledge_base(
  query_embedding vector(1536),
  query_text TEXT,
  search_user_id UUID,
  kb_ids UUID[] DEFAULT NULL,
  similarity_threshold FLOAT DEFAULT 0.2,
  match_count INT DEFAULT 10,
  rrf_k INT DEFAULT 50,
  full_text_weight FLOAT DEFAULT 1.0,
  semantic_weight FLOAT DEFAULT 1.0
) RETURNS TABLE (
  chunk_id UUID,
  document_id UUID,
  document_title TEXT,
  -- ... other fields
  snippet TEXT,         -- Highlighted excerpt
  similarity FLOAT,     -- Normalized score
  match_type TEXT       -- hybrid/fulltext/semantic
) AS $$ ... $$
```

### **Snippet Generation**

```sql
-- ts_headline generates snippets with highlighted keywords
ts_headline(
  'simple',                    -- Text search config (multilingual)
  c.content,                   -- Source text
  websearch_to_tsquery(query_text),  -- Query terms
  'StartSel=<mark>, StopSel=</mark>, MaxWords=60, MinWords=30'
)
```

---

## ğŸ’¬ Global Chat Widget

### **Features**

- âœ… **Always accessible** - Floating button in bottom-right corner
- âœ… **Searches both sources** - Knowledge Bases AND Analyzed Emails
- âœ… **Page context aware** - Can include current page info in search
- âœ… **Conversation memory** - Maintains chat history
- âœ… **Resizable** - Drag to resize widget
- âœ… **Result details** - Click to view full document content

### **Architecture**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GlobalChatWidget (components/chat/global-chat-widget.tsx)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ChatProvider (React Context)                                 â”‚   â”‚
â”‚  â”‚ â€¢ isOpen, isMinimized state                                  â”‚   â”‚
â”‚  â”‚ â€¢ messages[] (conversation history)                          â”‚   â”‚
â”‚  â”‚ â€¢ pageContext (from current route)                           â”‚   â”‚
â”‚  â”‚ â€¢ usePageContext toggle                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ handleChatSearch (Server Action)                            â”‚   â”‚
â”‚  â”‚ â€¢ Receives: query, agentConfigId?, emailId?, history        â”‚   â”‚
â”‚  â”‚ â€¢ Always searches BOTH KBs and Emails                       â”‚   â”‚
â”‚  â”‚ â€¢ Returns: AI response + KB results + Email results         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Results Display                                              â”‚   â”‚
â”‚  â”‚ â€¢ KB Results: title, kb_name, similarity, snippet            â”‚   â”‚
â”‚  â”‚ â€¢ Email Results: subject, from, content_type, snippet        â”‚   â”‚
â”‚  â”‚ â€¢ Match type badges (hybrid/fulltext/semantic)               â”‚   â”‚
â”‚  â”‚ â€¢ Click â†’ ResultDetailModal (full document content)          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **Page Context Flow**

```typescript
// useChatContext hook registers page context
useChatContext({
  agentConfigId: 'uuid',      // Current agent config
  currentEmailId: 'uuid',      // If viewing specific email
  kbId: 'uuid',                // If viewing specific KB
});

// When "Include page context" is ON:
// - Searches use assigned KBs from agent config
// - AI gets context about current email
// - Results filtered to relevant scope
```

### **UI Components**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [â”€] [Ã—]  AI Knowledge Search                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  ğŸ‘¤ User: Find .NET jobs in Aarhus                           â”‚
â”‚                                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                              â”‚
â”‚  ğŸ¤– Assistant: I found 6 relevant results...                 â”‚
â”‚                                                              â”‚
â”‚  ğŸ“š Knowledge Base Results (3)                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ CV - Henrik Fogbunzel.pdf              [hybrid] 57%    â”‚ â”‚
â”‚  â”‚ Cover letters pdf                                      â”‚ â”‚
â”‚  â”‚ Experience with <mark>.NET</mark> and C#...            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                              â”‚
â”‚  ğŸ“§ Email Results (3)                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Software Developer at BD Energy       [semantic] 45%   â”‚ â”‚
â”‚  â”‚ jobs-listings@linkedin.com                             â”‚ â”‚
â”‚  â”‚ Looking for <mark>.NET</mark> developer...             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [Page context ON] â˜‘                                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚ â”‚ Ask about your knowledge base or emails...       [â†’] â”‚    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Automated KB Search

### **Pipeline Integration (Step 8)**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Email Analysis Pipeline                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Step 1: Fetch Email                                                 â”‚
â”‚ Step 2: Extract Links                                               â”‚
â”‚ Step 3: AI Prioritization                                           â”‚
â”‚ Step 4: Content Retrieval                                           â”‚
â”‚ Step 5: Email Analysis                                              â”‚
â”‚ Step 6: Page Analysis                                               â”‚
â”‚ Step 7: Aggregation                                                 â”‚
â”‚                                                                     â”‚
â”‚ Step 8: AUTO KB SEARCH â­ NEW                                       â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ IF auto_search_kb_on_match = true AND matched = true           â”‚â”‚
â”‚ â”‚                                                                 â”‚â”‚
â”‚ â”‚ 1. Get assigned KBs from agent_kb_assignments                   â”‚â”‚
â”‚ â”‚ 2. Create strategy based on auto_search_mode:                   â”‚â”‚
â”‚ â”‚    â€¢ single: One combined query                                 â”‚â”‚
â”‚ â”‚    â€¢ multi_intent: Split by technologies/skills                 â”‚â”‚
â”‚ â”‚    â€¢ ai_powered: LLM generates optimal queries                  â”‚â”‚
â”‚ â”‚ 3. Generate search queries from extracted_data                  â”‚â”‚
â”‚ â”‚ 4. Execute parallel searches                                    â”‚â”‚
â”‚ â”‚ 5. Combine, deduplicate, rank results                           â”‚â”‚
â”‚ â”‚ 6. Store in analyzed_emails.kb_search_results                   â”‚â”‚
â”‚ â”‚ 7. Flag for auto-save if confidence >= threshold                â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **Configuration Fields (agent_configurations)**

```sql
-- New fields for automation
auto_search_kb_on_match      BOOLEAN DEFAULT false    -- Enable auto search
auto_save_matches_to_kb_id   UUID                     -- KB to save matches
auto_save_confidence_threshold NUMERIC DEFAULT 0.8   -- Min confidence for save
auto_search_query_template   TEXT                     -- Template for queries
auto_search_mode             TEXT DEFAULT 'single'    -- single|multi_intent|ai_powered
auto_search_instructions     TEXT                     -- AI instructions
```

### **Result Storage**

```sql
-- New fields on analyzed_emails
kb_search_results      JSONB      -- Full search results
kb_search_performed_at TIMESTAMP  -- When search was done

-- Example kb_search_results:
{
  "searchPerformedAt": "2025-11-28T11:30:49Z",
  "searchMode": "ai_powered",
  "queries": [
    { "query": "Java backend developer Aarhus C", "sourceField": null, "resultCount": 5 },
    { "query": ".NET developer Aarhus C", "sourceField": null, "resultCount": 5 },
    { "query": "Python developer Aarhus C", "sourceField": null, "resultCount": 5 }
  ],
  "results": [
    {
      "title": "CV - Henrik Fogbunzel.pdf",
      "kbName": "Cover letters pdf",
      "similarity": 0.577,
      "preview": "Experience with .NET...",
      "matchType": "hybrid",
      "documentId": "uuid",
      "knowledgeBaseId": "uuid"
    }
  ],
  "totalResults": 6,
  "processingTimeMs": 7163
}
```

---

## ğŸ§  Multi-Intent Query Strategies

### **Strategy Pattern Implementation**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ISearchQueryStrategy Interface                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ + name: string                                                      â”‚
â”‚ + mode: SearchMode                                                  â”‚
â”‚ + generateQueries(context): Promise<QueryGenerationResult>          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â–³                    â–³                    â–³
           â”‚                    â”‚                    â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ SingleStrategy  â”‚  â”‚ MultiIntent    â”‚  â”‚ AIPowered      â”‚
  â”‚ (single)        â”‚  â”‚ Strategy       â”‚  â”‚ Strategy       â”‚
  â”‚                 â”‚  â”‚ (multi_intent) â”‚  â”‚ (ai_powered)   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **Single Query Strategy**

```typescript
// Mode: 'single'
// Combines all extracted data into one query

Input:
{
  technologies: ['Java', '.NET', 'Python'],
  location: 'Aarhus C',
  experience_level: '0-3 years'
}

Output:
[
  {
    query: "Java .NET Python developer Aarhus C 0-3 years",
    priority: 1,
    reasoning: "Combined query from all extracted fields"
  }
]
```

### **Multi-Intent Strategy**

```typescript
// Mode: 'multi_intent'
// Splits array fields into separate queries

Input:
{
  technologies: ['Java', '.NET', 'Python'],
  location: 'Aarhus C',
  experience_level: '0-3 years'
}

Output:
[
  { query: "Java developer Aarhus C", sourceField: "technologies", sourceValue: "Java" },
  { query: ".NET developer Aarhus C", sourceField: "technologies", sourceValue: ".NET" },
  { query: "Python developer Aarhus C", sourceField: "technologies", sourceValue: "Python" }
]
```

### **AI-Powered Strategy**

```typescript
// Mode: 'ai_powered'
// Uses LLM to generate optimal queries

System Prompt:
"Generate optimal search queries for a hybrid search system.
The user is looking for: {user_intent}
Extracted data: {extracted_data}
Instructions: {auto_search_instructions}
Generate 3-5 queries that will find relevant documents."

Output:
[
  { query: "Java backend developer Aarhus C", reasoning: "Focus on primary technology" },
  { query: ".NET developer Aarhus C", reasoning: "Specific technology match" },
  { query: "Node.js developer Aarhus C", reasoning: "Cover JavaScript backend" },
  { query: "Python developer Aarhus C", reasoning: "Include data/ML stack" },
  { query: "React frontend developer Aarhus C", reasoning: "Cover fullstack role" }
]
```

### **Parallel Execution**

```typescript
// All queries execute in parallel
const searchPromises = intents.map(intent =>
  searchKnowledgeBases(intent.query, userId, kbIds, 5, 0.25)
)
const results = await Promise.all(searchPromises)

// Combine and deduplicate by document ID
// Keep highest similarity score for duplicates
// Final sort by combined RRF score
```

---

## ğŸ’¾ Database Schema

### **New Fields**

```sql
-- agent_configurations
ALTER TABLE agent_configurations ADD COLUMN
  auto_search_kb_on_match BOOLEAN DEFAULT false,
  auto_save_matches_to_kb_id UUID REFERENCES knowledge_bases(id),
  auto_save_confidence_threshold NUMERIC DEFAULT 0.8,
  auto_search_query_template TEXT,
  auto_search_mode TEXT DEFAULT 'single' 
    CHECK (auto_search_mode IN ('single', 'multi_intent', 'ai_powered')),
  auto_search_instructions TEXT;

-- analyzed_emails
ALTER TABLE analyzed_emails ADD COLUMN
  kb_search_results JSONB,
  kb_search_performed_at TIMESTAMP WITH TIME ZONE;

-- kb_chunks (for hybrid search)
ALTER TABLE kb_chunks ADD COLUMN
  fts tsvector GENERATED ALWAYS AS (to_tsvector('simple', content)) STORED;
CREATE INDEX idx_kb_chunks_fts ON kb_chunks USING gin(fts);

-- analyzed_email_embeddings (for hybrid search)
ALTER TABLE analyzed_email_embeddings ADD COLUMN
  fts tsvector GENERATED ALWAYS AS (to_tsvector('simple', embedded_text)) STORED;
CREATE INDEX idx_email_embeddings_fts ON analyzed_email_embeddings USING gin(fts);
```

### **Migrations**

- `021_add_automation_fields.sql` - Auto search config fields
- `022_implement_true_hybrid_search.sql` - RRF functions + FTS columns
- `023_add_search_snippets.sql` - ts_headline snippets
- `024_add_multi_intent_search.sql` - Multi-intent mode fields

---

## ğŸ—ï¸ Architecture Patterns

### **1. Strategy Pattern (Query Generation)**

```typescript
// Interface
interface ISearchQueryStrategy {
  name: string
  mode: SearchMode
  generateQueries(context: StrategyContext): Promise<QueryGenerationResult>
}

// Factory
function createSearchStrategy(mode: SearchMode): ISearchQueryStrategy {
  switch (mode) {
    case 'single': return new SingleQueryStrategy()
    case 'multi_intent': return new MultiIntentStrategy()
    case 'ai_powered': return new AIPoweredStrategy()
  }
}

// Usage - low coupling!
const strategy = createSearchStrategy(config.searchMode)
const queries = await strategy.generateQueries(context)
```

### **2. Tool Pattern (Chat Search)**

```typescript
// Interface (OpenAI function calling compatible)
interface IChatSearchTool {
  name: string
  getDefinition(): ChatCompletionTool
  execute(args: Record<string, unknown>, context: ToolExecutionContext): Promise<ToolExecutionResult>
}

// Implementations
class KBSearchTool implements IChatSearchTool { ... }
class EmailSearchTool implements IChatSearchTool { ... }
class FieldMatchTool implements IChatSearchTool { ... }
```

### **3. React Context (Global State)**

```typescript
// Provider wraps entire app
<ChatProvider>
  <App />
</ChatProvider>

// Hook for page context
function useChatContext(context: ChatPageContext): void
function useChat(): ChatContextValue
```

---

## ğŸ“ Important Files

### **Core Search**

| File | Purpose |
|------|---------|
| `lib/embeddings/service.ts` | Main search functions (searchKnowledgeBases, searchAnalyzedEmails) |
| `supabase/migrations/022_*.sql` | Hybrid search RPC functions |
| `supabase/migrations/023_*.sql` | Snippet generation with ts_headline |

### **Auto Search System**

| File | Purpose |
|------|---------|
| `lib/auto-search/types.ts` | Type definitions (SearchMode, SearchIntent, etc.) |
| `lib/auto-search/service.ts` | Main orchestrator (performAutoKBSearch) |
| `lib/auto-search/factory.ts` | Strategy factory |
| `lib/auto-search/strategies/single.ts` | Single query strategy |
| `lib/auto-search/strategies/multi-intent.ts` | Multi-intent strategy |
| `lib/auto-search/strategies/ai-powered.ts` | AI-powered strategy |

### **Chat Widget**

| File | Purpose |
|------|---------|
| `components/chat/chat-provider.tsx` | Global React context |
| `components/chat/global-chat-widget.tsx` | UI component |
| `lib/chat-search/types.ts` | Chat-specific types |
| `lib/chat-search/tools/kb-search-tool.ts` | KB search tool |
| `lib/chat-search/tools/email-search-tool.ts` | Email search tool |

### **Server Actions**

| File | Purpose |
|------|---------|
| `app/dashboard/results/actions.ts` | handleChatSearch server action |
| `app/dashboard/emails/actions.ts` | Email analysis with auto search |
| `app/dashboard/actions.ts` | Agent config CRUD |

---

## ğŸ¯ Usage Examples

### **Chat Widget Query**

```
User: "Find .NET jobs in Aarhus"

â†’ Searches KB chunks for ".NET" (hybrid)
â†’ Searches email embeddings for ".NET" (hybrid)
â†’ Returns results with snippets and match types
â†’ User clicks result â†’ Full document modal
```

### **Automated Search (ai_powered)**

```
Email extracted: { technologies: ['Java', '.NET', 'Python'], location: 'Aarhus C' }

â†’ AI generates queries:
   1. "Java backend developer Aarhus C"
   2. ".NET developer Aarhus C"
   3. "Python developer Aarhus C"
   4. "React frontend developer Aarhus C"
   5. "Node.js developer Aarhus C"

â†’ 5 parallel searches against assigned KBs
â†’ Results combined and deduplicated
â†’ Stored in analyzed_emails.kb_search_results
```

---

*Generated November 28, 2025*

